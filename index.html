<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>情緒地圖</title>
  <link rel="icon" href="static/entry/nchu_sg.jpg" type="image/ico" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- navbar的特效以及css-->
  <link rel="stylesheet" type="text/css" href="static/entry/css/sidebar.css">
  <link rel="stylesheet" type="text/css" href="static/entry/css/entry.css">
  <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.6/semantic.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
  <link rel="stylesheet" href="static/SentiMap/css/map.css" />

  <link rel="stylesheet" href="static/SentiMap/timeline/reset.css"> <!-- CSS reset -->
  <link rel="stylesheet" href="static/SentiMap/timeline/style.css"> <!-- Resource style -->
  <script src="static/SentiMap/timeline/modernizr.js"></script> <!-- Modernizr -->
  <style type="text/css">
    #map1 {    
        height: 500px; width: 49%; 
        margin-left: auto; margin-right: auto;
        position: relative;
        margin-top: 50px;
        display: inline-block;
    }
    #map2 {   
        height: 500px; width: 49%; 
        margin-left: auto; margin-right: auto;
        position: relative;
        margin-top: 50px;
        display: inline-block; 
    }
    #wrapper {
        width: 75%;
        margin: 0 auto;
    }
    #change_timeline{
        margin-top: 50px;
    }
  </style>
</head>
<body>

<div class="pusher">
  <div class="ui inverted  aligned segment">
  </div>

  <center>
      <div class="ui big label">
          添加議題:
          <div class="ui icon input">
            <input id="issue1" type="text" name="issue" placeholder="Search...">
            <i id="submit_form" class="inverted circular search link icon"></i>
          </div>
        </div>
  </center> 
  <center>
    <div id="change_timeline" class="ui buttons">
      <button id="change_yearTimeline" class="ui positive button">年</button>
      <div class="or"></div>
      <button id="change_monthTimeline" class="ui button">月</button>
    </div>
  </center>
  <!-- year timeline -->
  <section id="year_timeline" class="cd-horizontal-timeline">
    <div class="timeline">
      <div class="events-wrapper">
        <div class="events">
          <ol>
            <li><a href="#0" data-date="00/00/1996" class="selected">1996</a></li>
            <li><a href="#0" data-date="00/00/1997">1997</a></li>
            <li><a href="#0" data-date="00/00/1998">1998</a></li>
            <li><a href="#0" data-date="00/00/1999">1999</a></li>
            <li><a href="#0" data-date="00/00/2000">2000</a></li>
            <li><a href="#0" data-date="00/00/2001">2001</a></li>
            <li><a href="#0" data-date="00/00/2002">2002</a></li>
            <li><a href="#0" data-date="00/00/2003">2003</a></li>
            <li><a href="#0" data-date="00/00/2004">2004</a></li>
            <li><a href="#0" data-date="00/00/2005">2005</a></li>
            <li><a href="#0" data-date="00/00/2006">2006</a></li>
            <li><a href="#0" data-date="00/00/2007">2007</a></li>
            <li><a href="#0" data-date="00/00/2008">2008</a></li>
            <li><a href="#0" data-date="00/00/2009">2009</a></li>
            <li><a href="#0" data-date="00/00/2010">2010</a></li>
            <li><a href="#0" data-date="00/00/2011">2011</a></li>
            <li><a href="#0" data-date="00/00/2012">2012</a></li>
            <li><a href="#0" data-date="00/00/2013">2013</a></li>
            <li><a href="#0" data-date="00/00/2014">2014</a></li>
            <li><a href="#0" data-date="00/00/2015">2015</a></li>
            <li><a href="#0" data-date="00/00/2016">2016</a></li>
            <li><a href="#0" data-date="00/00/2017">2017</a></li>
          </ol>

          <span class="filling-line" aria-hidden="true"></span>
        </div> 
      </div> 
        
      <ul class="cd-timeline-navigation">
        <li><a href="#0" class="prev inactive">Prev</a></li>
        <li><a href="#0" class="next">Next</a></li>
      </ul>
    </div> 

    <div class="events-content">
      <ol>
        <li data-date="00/00/1996" class="selected"></li>
        <li data-date="00/00/1997"></li>
        <li data-date="00/00/1998"></li>
        <li data-date="00/00/1999"></li>
        <li data-date="00/00/2000"></li>
        <li data-date="00/00/2001"></li>
        <li data-date="00/00/2002"></li>
        <li data-date="00/00/2003"></li>
        <li data-date="00/00/2004"></li>
        <li data-date="00/00/2005"></li>
        <li data-date="00/00/2006"></li>
        <li data-date="00/00/2007"></li>
        <li data-date="00/00/2008"></li>
        <li data-date="00/00/2009"></li>
        <li data-date="00/00/2010"></li>
        <li data-date="00/00/2011"></li>
        <li data-date="00/00/2012"></li>
        <li data-date="00/00/2013"></li>
        <li data-date="00/00/2014"></li>
        <li data-date="00/00/2015"></li>
        <li data-date="00/00/2016"></li>
        <li data-date="00/00/2017"></li>
      </ol>
    </div>
  </section>
  
  <!-- month timeline -->
  <section id="month_timeline" class="cd-horizontal-timeline" hidden>
    <div class="timeline">
      <div class="events-wrapper">
        <div class="events">
          <ol>
            <li><a href="#0" data-date="00/00/0000" class="all_time selected">All time</a></li>
            <li><a href="#0" data-date="00/01/0000">Jan</a></li>
            <li><a href="#0" data-date="00/02/0000">Feb</a></li>
            <li><a href="#0" data-date="00/03/0000">Mar</a></li>
            <li><a href="#0" data-date="00/04/0000">Apr</a></li>
            <li><a href="#0" data-date="00/05/0000">May</a></li>
            <li><a href="#0" data-date="00/06/0000">Jun</a></li>
            <li><a href="#0" data-date="00/07/0000">Jul</a></li>
            <li><a href="#0" data-date="00/08/0000">Aug</a></li>
            <li><a href="#0" data-date="00/09/0000">Sep</a></li>
            <li><a href="#0" data-date="00/10/0000">Oct</a></li>
            <li><a href="#0" data-date="00/11/0000">Nov</a></li>
            <li><a href="#0" data-date="00/12/0000">Dec</a></li>
          </ol>

          <span class="filling-line" aria-hidden="true"></span>
        </div> 
      </div> 
        
      <ul class="cd-timeline-navigation">
        <li><a href="#0" class="prev inactive">Prev</a></li>
        <li><a href="#0" class="next">Next</a></li>
      </ul>
    </div> 

    <div class="events-content">
      <ol>
        <li data-date="00/00/0000" class="all_time selected"></li>
        <li data-date="00/01/0000"></li>
        <li data-date="00/02/0000"></li>
        <li data-date="00/03/0000"></li>
        <li data-date="00/04/0000"></li>
        <li data-date="00/05/0000"></li>
        <li data-date="00/06/0000"></li>
        <li data-date="00/07/0000"></li>
        <li data-date="00/08/0000"></li>
        <li data-date="00/09/0000"></li>
        <li data-date="00/10/0000"></li>
        <li data-date="00/11/0000"></li>
        <li data-date="00/12/0000"></li>
      </ol>
    </div>
  </section>
  <div id="wrapper">
    <div id="map1"></div>
    <div id="map2"></div>
  </div>
  <center>
    <canvas id="my_canvas" width="500" height="500"></canvas>
  </center>

</div>
</body>

<!-- 引入Ｊs TAG -->
<!-- 引入Ｊquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<!-- 引入Ｊs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.6/semantic.min.js"></script>
<script src="static/entry/js/pusher.js"></script>
<script src="static/entry/js/visibility.js"></script>
<script src="static/entry/js/sidebar.js"></script>
<script src="static/entry/js/transition.js"></script>
<!-- 引入Ｊs TAG -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.5/leaflet.js"></script>
<!--MapName是從view傳過來的地圖名稱變數 with可以讓我們在template做變數的儲存 add可以串接字串-->
<script src="static/SentiMap/js/taiwan.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.6/semantic.min.js"></script>
<script src="static/SentiMap/timeline/jquery.mobile.custom.min.js"></script>
<script src="static/SentiMap/timeline/main.js"></script> <!-- Resource jQuery -->
<script src="static/SentiMap/js/wordcloud2.js"></script> <!-- Modernizr -->
<script type="text/javascript">
  $('#change_yearTimeline').click(function(){
      $("#year_timeline").removeAttr("hidden");
      $("#month_timeline").attr("hidden","");
      $("#change_monthTimeline").removeClass("positive");
      $(this).addClass("positive");
  });
  $('#change_monthTimeline').click(function(){
      $("#month_timeline").removeAttr("hidden");
      $("#year_timeline").attr("hidden","");
      $("#change_yearTimeline").removeClass("positive");
      $(this).addClass("positive");
  });
</script>
<script>
  
      var target=[];
      var sort_key=[];
      var sort_val=[];
      var cnt=0;
      var translation={
         "Taichung" : "台中市",
         "Miaoli" : "苗栗縣",
         "Chiai" : "嘉義縣",
         "Chiayi" : "嘉義縣",
         "Taipei" : "新北市",
         "Taoyüan" : "桃園縣",
         "Taoyuan City" : "桃園縣",
         "Taoyuan District" : "桃園縣",
         "Kaohsiung" : "高雄市",
         "Taipei City" : "台北市",
         "Tainan" : "台南市",
         "Keelung" : "基隆市",
         "Nantou" : "南投縣",
         // "" : "新北市",
         // "" : "新竹市",
         "Yünlin" : "雲林縣",
         "Changhua" : "彰化縣",
         "Hsinchu" : "新竹縣",
         "Pingtung" : "屏東縣",
         "Ilan" : "宜蘭縣",
         "Hualien" : "花蓮縣",
         "Hualian" : "花蓮縣",
         "Taitung" : "台東縣",
         // "" : "金門縣",
         "Penghu" : "澎湖縣",
         "Chiayi" : "嘉義市"
      }
      target[0]={}
      var map = L.map('map1', {
          center: [24.06, 121.00],
          zoom: 8,
        });
      L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
        maxZoom: 20,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
          '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
          'Imagery © <a href="http://mapbox.com">Mapbox</a>',
        id: 'mapbox.light'
      }).addTo(map);

      function getColor(d) {
        var senti_number=-100
        if(!$.isNumeric(d))
        {
          for(i=0;i<sort_key.length;i++)
          {
            if(sort_key[i]==d)
            {
              senti_number=i+1
              break;
            }
          }
        }
        else
        {
          senti_number=d
        }
        return senti_number == 1 ? '#FF0000' :
         senti_number == 2  ? '#FF4000' :
         senti_number == 3  ? '#FFBF00' :
         senti_number == 4  ? '#FFFF00' :
         senti_number == 5  ? '#F3F781' :
         senti_number == 6   ? '#58FAF4' :
         senti_number == 7   ? '#00BFFF' :
         senti_number == 8  ? '#0174DF' :
         senti_number == 9   ? '#0431B4' :
         senti_number == -100  ? '#A4A4A4' :
                    '#0000FF';
    }
      function style(feature) {
          return {
              fillColor: getColor(feature.properties.name),
              weight: 2,
              opacity: 1,
              color: 'white',
              dashArray: '3',
              fillOpacity: 0.7
          };
      }
      function highlightFeature(e) {
          var layer = e.target;

          layer.setStyle({
              weight: 5,
              color: '#FA5858',
              dashArray: '',
              fillOpacity: 0.7
          });

          if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
              layer.bringToFront();
          }
          info.update(layer.feature.properties);
      }
      function resetHighlight(e) {
          geojson.resetStyle(e.target);
          info.update();
      }
      function zoomToFeature(e) {
          map.fitBounds(e.target.getBounds());
      }
      function onEachFeature(feature, layer) {
          layer.on({
              mouseover: highlightFeature,
              mouseout: resetHighlight,
              click: zoomToFeature
          });
      }
      var info = L.control();

      info.onAdd = function (map) {
          this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
          this.update();
          return this._div;
      };

      // method that we will use to update the control based on feature properties passed
      info.update = function (props) {
          
          this._div.innerHTML = '<h4>台灣地區 正面評價</h4>' +  (props ?
              '<b>' + props.name + '</b><br />' + (get_sentiNumber(props.name)) + '</sup>'
              : 'Hover over a state');
      };
      var legend = L.control({position: 'bottomright'});

      legend.onAdd = function (map) {

          var div = L.DomUtil.create('div', 'info legend'),
              grades = [1,2,3,4,5,6,7,8,9],
              labels = [];

          // loop through our density intervals and generate a label with a colored square for each interval
          for (var i = 0; i < grades.length; i++) {
              div.innerHTML +=
                  '<i style="background:' + getColor(grades[i]) + '"></i> ' +grades[i]  ;
              if(i!=9)
              {
                div.innerHTML+= '<br>';
              }
          }

          return div;
      };


      geojson = L.geoJson(statesData, {
          style: style,
          onEachFeature: onEachFeature
      }).addTo(map);
      info.addTo(map);
      legend.addTo(map);

      function get_sentiNumber(area_name){
        try
        {
          var senti_number = -100;
          var attendee=0;
          var get_data=0;
          $.each(target[0].map.Taiwan,function(uk,uv){
            if(uk==area_name)
            {
              senti_number += uv.positive;
              attendee += uv.attendee;
              get_data=1;
            }
          });
          if(get_data==1)
          {
            senti_number+=100
            senti_number/=attendee;
          }
          return senti_number;
        }
        catch(e)
        {
          console.log("issue is necessary,and wait to redraw map")
        }
        
      }
      function sortValue(){
        var k;
        for(i=0;i<sort_val.length;i++)
        {
          for(j=i;j<sort_val.length;j++)
          {
            if(sort_val[i]<sort_val[j])
            {
              k=sort_val[i]
              sort_val[i]=sort_val[j]
              sort_val[j]=k
              k=sort_key[i]
              sort_key[i]=sort_key[j]
              sort_key[j]=k
            }
          }
        }
        for(i=0;i<sort_val2.length;i++)
        {
          for(j=i;j<sort_val2.length;j++)
          {
            if(sort_val2[i]>sort_val2[j])
            {
              k=sort_val2[i]
              sort_val2[i]=sort_val2[j]
              sort_val2[j]=k
              k=sort_key2[i]
              sort_key2[i]=sort_key2[j]
              sort_key2[j]=k
            }
          }
        }
      }
      function translate(k){
        var rtn_val=k;
        $.each(translation,function(uk,uv){

          if(uk==k)
          {
            rtn_val=uv
            return false;
          }
        });
        return rtn_val;
      }
      $('#issue1').keypress(function (e) {
        code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)
        {
            submit_form();
        }
      });
      $( "#submit_form" ).click(function() {
          submit_form();
      });
      function submit_form(){
        if($.trim( $('#issue1').val() ) != '')
          {
              var issue = $('#issue1').val();
              $.getJSON( "http://140.120.13.243:10001/PTT_KCM_API/api/locations/?issue="+issue, function(data){
                  $.each(data.map.Taiwan,function(uk,uv){
                      var CHkey = translate(uk);
                      if(CHkey!=uk)
                      {
                        if("CHkey" in data.map.Taiwan)
                        {
                          data.map.Taiwan[CHkey] += uv;
                        }
                        else
                        {
                          data.map.Taiwan[CHkey] = uv;
                        }
                        
                        delete data.map.Taiwan[uk];
                      }
                  });
                  console.log(data)
                  target[0]=data;
                  //redraw geojson
                  cnt=0
                  geojson.eachLayer(function (layer) {
                      var area = layer.feature.properties.name;
                      var sumOfScore_p = get_sentiNumber(area)
                      if(sumOfScore_p!=-100)
                      {
                        sort_key[cnt]=area;
                        sort_val[cnt]=sumOfScore_p;
                      }
                      var sumOfScore_n = get_sentiNumber2(area)
                      if(sumOfScore_n!=-100)
                      {
                        sort_key2[cnt]=area;
                        sort_val2[cnt]=sumOfScore_n;
                        cnt++
                      }
                  });
                  sortValue();
                  geojson.eachLayer(function (layer) {     
                      layer.setStyle({fillColor :getColor(layer.feature.properties.name)}) 
                  });
                  geojson2.eachLayer(function (layer) {     
                      layer.setStyle({fillColor :getColor2(layer.feature.properties.name)}) 
                  });
              });

              // $.getJSON( "http://140.120.13.243:8000/PTT_KCM_API/api/tfidf/?issue="+issue, function(data){

              //     var dic_list={}
              //     $.each(data.articleList,function(uk,uv){
              //         $.each(uv['tfidf'],function(mk,mv){
              //             if(!dic_list.hasOwnProperty(mk))
              //             {
              //               dic_list[mk]=0
              //             }
              //             dic_list[mk]+=1
              //         })
              //     });
              //     var max_ten=[["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0]]
              //     var min=0;
              //     var max=0;
              //     $.each(dic_list,function(uk,uv){
              //       if(!$.isNumeric(uk))
              //       {
              //         for(i=0;i<20;i++)
              //         {
              //           if(max_ten[i][1]<max_ten[min][1])
              //           {
              //               min=i
              //           }
              //         }
              //         if(max_ten[min][1]<uv)
              //         {
              //           max_ten.splice(min,1)
              //           var local_list=[]
              //           local_list[0]=uk
              //           local_list[1]=uv
              //           max_ten.push(local_list)
              //         }
              //       }
              //     });
              //     for(i=0;i<20;i++)
              //     {
              //       if(max_ten[i][1]>max_ten[max][1])
              //       {
              //           max=i
              //       }
              //     }
              //     console.log(max_ten)
              //     WordCloud($('#my_canvas')[0], { list:max_ten , gridSize: 10,weightFactor: 70/max_ten[max][1],fontFamily: 'Average, Times, serif',});

              // })
          }
      }

</script>
<script>
      var sort_key2=[];
      var sort_val2=[];
      var map2 = L.map('map2', {
          center: [24.06, 121.00],
          zoom: 8,
        });
      L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
        maxZoom: 20,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
          '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
          'Imagery © <a href="http://mapbox.com">Mapbox</a>',
        id: 'mapbox.light'
      }).addTo(map2);

      function getColor2(d) {
          var senti_number=-100;
          if(!$.isNumeric(d))
          {
            for(i=0;i<sort_key2.length;i++)
            {
              if(sort_key2[i]==d)
              {
                senti_number=i+1
                break;
              }
            }
          }
          else
          {
            senti_number=d
          }
          return senti_number == 1 ? '#FF0000' :
           senti_number == 2  ? '#FF4000' :
           senti_number == 3  ? '#FFBF00' :
           senti_number == 4  ? '#FFFF00' :
           senti_number == 5  ? '#F3F781' :
           senti_number == 6   ? '#58FAF4' :
           senti_number == 7   ? '#00BFFF' :
           senti_number == 8  ? '#0174DF' :
           senti_number == 9   ? '#0431B4' :
           senti_number == -100  ? '#A4A4A4' :
                      '#0000FF';
      }
      function style2(feature) {
          return {
              fillColor: getColor2(feature.properties.name),
              weight: 2,
              opacity: 1,
              color: 'white',
              dashArray: '3',
              fillOpacity: 0.7
          };
      }
      function highlightFeature2(e) {
          var layer = e.target;

          layer.setStyle({
              weight: 5,
              color: '#FA5858',
              dashArray: '',
              fillOpacity: 0.7
          });

          if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
              layer.bringToFront();
          }
          info2.update(layer.feature.properties);
      }
      function resetHighlight2(e) {
          geojson2.resetStyle(e.target);
          info2.update();
      }
      function zoomToFeature2(e) {
          map2.fitBounds(e.target.getBounds());
      }
      function onEachFeature2(feature, layer) {
          layer.on({
              mouseover: highlightFeature2,
              mouseout: resetHighlight2,
              click: zoomToFeature2
          });
      }
      var info2 = L.control();

      info2.onAdd = function (map) {
          this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
          this.update();
          return this._div;
      };

      // method that we will use to update the control based on feature properties passed
      info2.update = function (props) {
          
          this._div.innerHTML = '<h4>台灣地區 負面評價</h4>' +  (props ?
              '<b>' + props.name + '</b><br />' + (get_sentiNumber2(props.name)) + ' </sup>'
              : 'Hover over a state');
      };
      var legend = L.control({position: 'bottomright'});

      legend.onAdd = function (map) {

          var div = L.DomUtil.create('div', 'info legend'),
              grades = [1,2,3,4,5,6,7,8,9],
              labels = [];

          // loop through our density intervals and generate a label with a colored square for each interval
          for (var i = 0; i < grades.length; i++) {
              div.innerHTML +=
                  '<i style="background:' + getColor2(grades[i]) + '"></i> ' +grades[i]  ;
              if(i!=9)
              {
                div.innerHTML+= '<br>';
              }
          }

          return div;
      };


      geojson2 = L.geoJson(statesData, {
          style: style2,
          onEachFeature: onEachFeature2
      }).addTo(map2);
      info2.addTo(map2);
      legend.addTo(map2);

      function get_sentiNumber2(area_name){
        try
        {
          var senti_number = -100;
          var attendee=0;
          var get_data=0;
          $.each(target[0].map.Taiwan,function(uk,uv){
            if(uk==area_name)
            {
              senti_number += uv.negative;
              attendee += uv.attendee;
              get_data=1;
            }
          });
          if(get_data==1)
          {
            senti_number+=100
            senti_number/=attendee;
          }
          return senti_number;
        }
        catch(e)
        {
          console.log("issue is necessary,and wait to redraw map")
        }
          
      }
</script>
<!-- <script async defer src="http://api.windyty.com/v2.1/boot.js"></script>  -->
<!-- <script src="/static/Sentimap/js/boot.js"></script> -->
</html>
